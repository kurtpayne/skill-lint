from __future__ import annotations

import re
from pathlib import Path

from skilllint.core.result import Finding


PATTERNS = [
    ("shell_exec", re.compile(r"\b(os\.system|subprocess\.|eval\(|exec\()", re.I), "high"),
    ("download_exec", re.compile(r"\b(curl|wget).*(\||;).*(sh|bash|python)\b", re.I), "critical"),
]


def analyze(path: Path, text: str) -> list[Finding]:
    out: list[Finding] = []
    for i, line in enumerate(text.splitlines(), start=1):
        for pid, rx, sev in PATTERNS:
            if rx.search(line):
                out.append(
                    Finding(
                        id=f"SEC-MAL-{pid}",
                        source="security",
                        severity=sev,
                        confidence=0.8,
                        category="malware_pattern",
                        file=str(path),
                        line_start=i,
                        line_end=i,
                        evidence=line.strip()[:300],
                        title=f"Risky execution pattern: {pid}",
                        remediation="Avoid dynamic execution paths and shelling out on untrusted content.",
                    )
                )
    return out
