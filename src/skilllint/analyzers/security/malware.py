from __future__ import annotations

from pathlib import Path

from skilllint.analyzers.security._patterns import build_patterns, run_line_patterns
from skilllint.core.result import Finding


def analyze(path: Path, text: str, intel_patterns: list[dict] | None = None) -> list[Finding]:
    base = [
        {
            "id": "shell_exec",
            "regex": r"\b(os\.system|subprocess\.|eval\(|exec\()",
            "severity": "high",
            "confidence": 0.82,
            "title": "Risky dynamic execution pattern",
            "remediation": "Avoid dynamic execution paths and shelling out on untrusted content.",
        },
        {
            "id": "download_exec",
            "regex": r"\b(curl|wget).*(\||;).*(sh|bash|python)\b",
            "severity": "critical",
            "confidence": 0.92,
            "title": "Download-and-execute pipeline",
            "remediation": "Remove one-liner execution pipelines and verify downloaded artifacts.",
        },
    ]
    patterns = build_patterns(base + (intel_patterns or []))
    return run_line_patterns(path, text, "malware_pattern", "SEC-MAL", patterns)
